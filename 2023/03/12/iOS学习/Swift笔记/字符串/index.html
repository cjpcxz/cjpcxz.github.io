<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>字符串 | Ayer</title><meta name="author" content="jingbo"><meta name="copyright" content="jingbo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一个字符串变量占用多少内存 显然一个字符串占有16个字节  12345var str1 &#x3D; &quot;0123456789&quot;var str2 &#x3D; &quot;0123456789ABCDEFGHIGK&quot;MemoryLayout&lt;String&gt;.stride. &#x2F;&#x2F;16MemoryLayout.stride(ofValue: str1) &#x2F;&#x2F;16MemoryLayo">
<meta property="og:type" content="article">
<meta property="og:title" content="字符串">
<meta property="og:url" content="http://example.com/2023/03/12/iOS%E5%AD%A6%E4%B9%A0/Swift%E7%AC%94%E8%AE%B0/%E5%AD%97%E7%AC%A6%E4%B8%B2/index.html">
<meta property="og:site_name" content="Ayer">
<meta property="og:description" content="一个字符串变量占用多少内存 显然一个字符串占有16个字节  12345var str1 &#x3D; &quot;0123456789&quot;var str2 &#x3D; &quot;0123456789ABCDEFGHIGK&quot;MemoryLayout&lt;String&gt;.stride. &#x2F;&#x2F;16MemoryLayout.stride(ofValue: str1) &#x2F;&#x2F;16MemoryLayo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/banner/banner_54.jpeg">
<meta property="article:published_time" content="2023-03-12T08:02:28.000Z">
<meta property="article:modified_time" content="2023-07-03T17:27:46.158Z">
<meta property="article:author" content="jingbo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/banner/banner_54.jpeg"><link rel="shortcut icon" href="/img/avatar.png"><link rel="canonical" href="http://example.com/2023/03/12/iOS%E5%AD%A6%E4%B9%A0/Swift%E7%AC%94%E8%AE%B0/%E5%AD%97%E7%AC%A6%E4%B8%B2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '字符串',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-04 01:27:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Ayer" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">97</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">17</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/banner/banner_54.jpeg')"><nav id="nav"><span id="blog-info"><a href="/" title="Ayer"><span class="site-name">Ayer</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">字符串</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-03-12T08:02:28.000Z" title="Created 2023-03-12 16:02:28">2023-03-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-07-03T17:27:46.158Z" title="Updated 2023-07-04 01:27:46">2023-07-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/swift%E7%AC%94%E8%AE%B0/">swift笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="字符串"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一个字符串变量占用多少内存"><a href="#一个字符串变量占用多少内存" class="headerlink" title="一个字符串变量占用多少内存"></a>一个字符串变量占用多少内存</h1><blockquote>
<p>显然一个字符串占有<code>16</code>个字节</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">var</span> str1 <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0123456789&quot;</span><br><span class="hljs-keyword">var</span> str2 <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0123456789ABCDEFGHIGK&quot;</span><br><span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">String</span>&gt;.stride. <span class="hljs-comment">//16</span><br><span class="hljs-type">MemoryLayout</span>.stride(ofValue: str1) <span class="hljs-comment">//16</span><br><span class="hljs-type">MemoryLayout</span>.stride(ofValue: str2) <span class="hljs-comment">//16</span><br></code></pre></td></tr></table></figure>

<h1 id="字符串的底层存储"><a href="#字符串的底层存储" class="headerlink" title="字符串的底层存储"></a>字符串的底层存储</h1><h2 id="小于长度0xF的字符串"><a href="#小于长度0xF的字符串" class="headerlink" title="小于长度0xF的字符串"></a>小于长度<code>0xF</code>的字符串</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">var</span> str1 <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0123456789&quot;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>汇编查看<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-number">0x10000dfd9</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">25</span><span class="hljs-operator">&gt;</span>:  callq  <span class="hljs-number">0x10000e1c2</span>               ; symbol stub <span class="hljs-keyword">for</span>: <span class="hljs-type">Swift</span>.<span class="hljs-type">String</span>.<span class="hljs-keyword">init</span>(_builtinStringLiteral: <span class="hljs-type">Builtin</span>.<span class="hljs-type">RawPointer</span>, utf8CodeUnitCount: <span class="hljs-type">Builtin</span>.<span class="hljs-type">Word</span>, isASCII: <span class="hljs-type">Builtin</span>.<span class="hljs-type">Int1</span>) -&gt; <span class="hljs-type">Swift</span>.<span class="hljs-type">String</span><br>    <span class="hljs-number">0x10000dfde</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">30</span><span class="hljs-operator">&gt;</span>:  movq   <span class="hljs-operator">%</span>rax, <span class="hljs-number">0x71fb</span>(<span class="hljs-operator">%</span>rip)        ; <span class="hljs-type">SwiftDText</span>.str1 : <span class="hljs-type">Swift</span>.<span class="hljs-type">String</span><br>    <span class="hljs-number">0x10000dfe5</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">37</span><span class="hljs-operator">&gt;</span>:  movq   <span class="hljs-operator">%</span>rdx, <span class="hljs-number">0x71fc</span>(<span class="hljs-operator">%</span>rip)        ; <span class="hljs-type">SwiftDText</span>.str1 : <span class="hljs-type">Swift</span>.<span class="hljs-type">String</span> <span class="hljs-operator">+</span> <span class="hljs-number">8</span><br></code></pre></td></tr></table></figure></li>
<li>分析，这里将<code>rax</code>和<code>rdx</code>的分别赋值给了<code>str1</code>(地址是<code>0x1000151E0</code>)的前8个字节和后8个字节，<code>register read rax</code>查看<ul>
<li><code>x 0x1000151E0</code> -&gt; <code>30 31 32 33 34 35 36 37 38 39 00 00 00 00 00 ea</code>,查看<code>str1</code>地址内存,小端模式（低低高高）</li>
<li><code>rax = 0x3736353433323130</code>，<code>rdx = 0xea00000000003938</code>,根据<a target="_blank" rel="noopener" href="https://www.ascii-code.com/">ASCII码表</a>可知<code>30-39</code>是<code>0-9</code>。<strong>显然</strong>,字符串直接存储在<code>str1</code>地址的内存上</li>
<li><code>0xea</code>,存储的实际是字符串的<code>tag</code>和长度，其中<code>e</code>是<code>tag</code>,而<code>a</code>是<code>10</code>即字符串的长度<ul>
<li><code>&quot;0123456789ABCDE&quot;</code>的内存<code>30 31 32 33 34 35 36 37 38 39 41 42 43 44 45 ef</code>,显然最后的长度变成了<code>f</code>即<code>15</code>,<code>e</code>是<code>tag</code></li>
<li><code>&quot;0123456789ABCDEF&quot;</code>上<code>10 00 00 00 00 00 00 d0 f0 f5 00 00 01 00 00 80</code>,<code>0xd000000000000010</code> + <code>0x800000010000f5f0</code>,显然和前面的不同。其存储的方式发生了改变</li>
</ul>
</li>
<li><strong>总结</strong>，如果字符串长度小于<code>0xF</code>，其字符串直接存储在地址的内存上，其第<code>16</code>个字节上，存储者字符串的<code>tag</code>和<code>长度</code>。而字符串长度大于<code>0xF</code>，其存储方式发生了改变</li>
</ul>
</li>
</ul>
<h2 id="大于长度0xF的字符串"><a href="#大于长度0xF的字符串" class="headerlink" title="大于长度0xF的字符串"></a>大于长度<code>0xF</code>的字符串</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">var</span> str2 <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0123456789ABCDEF&quot;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>根据其内存，其内存地址是 <code>0xd000000000000010</code> + <code>0x8000000100003f50</code></li>
<li>汇编查看<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-number">0x10000dfb8</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">8</span><span class="hljs-operator">&gt;</span>:   leaq   <span class="hljs-number">0x1651</span>(<span class="hljs-operator">%</span>rip), <span class="hljs-operator">%</span>rdi        ; <span class="hljs-string">&quot;0123456789ABCDEF&quot;</span><br>    <span class="hljs-number">0x10000dfbf</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">15</span><span class="hljs-operator">&gt;</span>:  movl   <span class="hljs-variable">$0</span>x10, <span class="hljs-operator">%</span>esi<br>    <span class="hljs-number">0x10000dfc4</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">20</span><span class="hljs-operator">&gt;</span>:  movl   <span class="hljs-variable">$0</span>x1, <span class="hljs-operator">%</span>edx<br>-&gt;  <span class="hljs-number">0x10000dfc9</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">25</span><span class="hljs-operator">&gt;</span>:  callq  <span class="hljs-number">0x10000e1b2</span>               ; symbol stub <span class="hljs-keyword">for</span>: <span class="hljs-type">Swift</span>.<span class="hljs-type">String</span>.<span class="hljs-keyword">init</span>(_builtinStringLiteral: <span class="hljs-type">Builtin</span>.<span class="hljs-type">RawPointer</span>, utf8CodeUnitCount: <span class="hljs-type">Builtin</span>.<span class="hljs-type">Word</span>, isASCII: <span class="hljs-type">Builtin</span>.<span class="hljs-type">Int1</span>) -&gt; <span class="hljs-type">Swift</span>.<span class="hljs-type">String</span><br>    <span class="hljs-number">0x10000dfce</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">30</span><span class="hljs-operator">&gt;</span>:  movq   <span class="hljs-operator">%</span>rax, <span class="hljs-number">0x720b</span>(<span class="hljs-operator">%</span>rip)        ; <span class="hljs-type">SwiftDText</span>.str1 : <span class="hljs-type">Swift</span>.<span class="hljs-type">String</span><br>    <span class="hljs-number">0x10000dfd5</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">37</span><span class="hljs-operator">&gt;</span>:  movq   <span class="hljs-operator">%</span>rdx, <span class="hljs-number">0x720c</span>(<span class="hljs-operator">%</span>rip)        ; <span class="hljs-type">SwiftDText</span>.str1 : <span class="hljs-type">Swift</span>.<span class="hljs-type">String</span> <span class="hljs-operator">+</span> <span class="hljs-number">8</span><br>    <br><span class="hljs-operator">-------</span><br>libswiftCore.dylib`<span class="hljs-type">Swift</span>.<span class="hljs-type">String</span>.<span class="hljs-keyword">init</span><br>    <span class="hljs-number">0x7ff819e87ae0</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">32</span><span class="hljs-operator">&gt;</span>:  cmpq   <span class="hljs-variable">$0</span>xf, <span class="hljs-operator">%</span>rsi<br>    <span class="hljs-number">0x7ff819e87ae4</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">36</span><span class="hljs-operator">&gt;</span>:  jle    <span class="hljs-number">0x7ff819e87b26</span>            ; <span class="hljs-operator">&lt;+</span><span class="hljs-number">102</span><span class="hljs-operator">&gt;</span><br>    <span class="hljs-number">0x7ff819e87ae6</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">38</span><span class="hljs-operator">&gt;</span>:  movabsq $<span class="hljs-operator">-</span><span class="hljs-number">0x4000000000000000</span>, <span class="hljs-operator">%</span>rcx ; imm <span class="hljs-operator">=</span> <span class="hljs-number">0xC000000000000000</span> <br>    <span class="hljs-number">0x7ff819e87af0</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">48</span><span class="hljs-operator">&gt;</span>:  orq    <span class="hljs-operator">%</span>rsi, <span class="hljs-operator">%</span>rcx<br>    <span class="hljs-number">0x7ff819e87af3</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">51</span><span class="hljs-operator">&gt;</span>:  testb  <span class="hljs-variable">$0</span>x1, <span class="hljs-operator">%</span>al<br>    <span class="hljs-number">0x7ff819e87af5</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">53</span><span class="hljs-operator">&gt;</span>:  cmoveq <span class="hljs-operator">%</span>rsi, <span class="hljs-operator">%</span>rcx<br>    <span class="hljs-number">0x7ff819e87af9</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">57</span><span class="hljs-operator">&gt;</span>:  movabsq <span class="hljs-variable">$0</span>x1000000000000000, <span class="hljs-operator">%</span>rax ; imm <span class="hljs-operator">=</span> <span class="hljs-number">0x1000000000000000</span> <br>    <span class="hljs-number">0x7ff819e87b03</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">67</span><span class="hljs-operator">&gt;</span>:  orq    <span class="hljs-operator">%</span>rcx, <span class="hljs-operator">%</span>rax<br>    <span class="hljs-number">0x7ff819e87b06</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">70</span><span class="hljs-operator">&gt;</span>:  movabsq <span class="hljs-variable">$0</span>x7fffffffffffffe0, <span class="hljs-operator">%</span>rdx ; imm <span class="hljs-operator">=</span> <span class="hljs-number">0x7FFFFFFFFFFFFFE0</span> <br>    <span class="hljs-number">0x7ff819e87b10</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">80</span><span class="hljs-operator">&gt;</span>:  addq   <span class="hljs-operator">%</span>rdx, <span class="hljs-operator">%</span>rdi<br>    <span class="hljs-number">0x7ff819e87b13</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">83</span><span class="hljs-operator">&gt;</span>:  addq   <span class="hljs-variable">$0</span>x20, <span class="hljs-operator">%</span>rdx<br>-&gt;  <span class="hljs-number">0x7ff819e87b17</span> <span class="hljs-operator">&lt;+</span><span class="hljs-number">87</span><span class="hljs-operator">&gt;</span>:  orq    <span class="hljs-operator">%</span>rdi, <span class="hljs-operator">%</span>rdx<br></code></pre></td></tr></table></figure></li>
<li>分析,这里字符串<code>&quot;0123456789ABCDEF&quot;</code>的地址赋值给了<code>rdi = 0x0000000100003f70  &quot;0123456789ABCDEF&quot;</code>,将字符串的长度<code>0x10</code>传给了<code>esi</code>（即<code>rsi</code>）</li>
<li>在<code>Swift.String.init</code>方法中会<code>cmpq   $0xf, %rsi</code>会对字符串的长度，进行判断然后处理，这里<code>addq   %rdx, %rdi</code>,这里将<code>rdx</code>和<code>rdi</code>中的值相加，然后赋值给<code>rdi</code>(最终复制给了<code>rdx</code>),这里<code>rdi</code>是<code>0x7fffffffffffffe0</code> + <code>0x0000000100003f70</code> = <code>0x8000000100003f50</code>,即字符串<code>后8字节</code>存储的内容,显然字符串后8字节减去<code>0x7fffffffffffffe0</code>存储着字符串的内存地址。</li>
<li>其<code>前8字节</code>存储的实际是字符串的<code>tag</code>和<code>长度</code><ul>
<li><code>&quot;0123456789ABCDEFGH&quot;</code>的内存地址<code>0xd000000000000012</code> + <code>0x8000000100003f70</code></li>
<li>显然，其高位<code>d</code>代表大于<code>oxF</code>的字符串存储方法，低位开始代表字符串的长度</li>
</ul>
</li>
<li>大于<code>oxF</code>的字符串存储的字符串真实地址位置实际在<code>__TEXT.cstring</code>常量区,<code>&quot;0123456789ABCDEF&quot;</code>的真实内存地址是<code>0x0000000100003f70</code><ul>
<li><code>swiftc -o main.o main.swift</code>,编译成<code>.o</code>文件，用<code>machOview</code>查看</li>
<li>显然<code>3f70</code>是在<code>__TEXT.cstring</code>常量区，且小于<code>oxF</code>存在内存上的字符串，在常量区，仍有备份<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="1.png"></li>
</ul>
</li>
</ul>
<h2 id="字符串拼接后的内存放在那里"><a href="#字符串拼接后的内存放在那里" class="headerlink" title="字符串拼接后的内存放在那里"></a>字符串拼接后的内存放在那里</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">var</span> str1 <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0123456789ABCD&quot;</span><br>str1.append(<span class="hljs-string">&quot;E&quot;</span>)<br>str1.append(<span class="hljs-string">&quot;G&quot;</span>)<br></code></pre></td></tr></table></figure>
<ul>
<li>添加长度小于<code>0xF</code>，直接查看内存<code>str1</code>的地址是<code>0x1000151E0</code>,<ul>
<li><code>x 0x1000151E0</code> -&gt; <code>30 31 32 33 34 35 36 37 38 39 41 42 43 44 00 ee</code></li>
<li><code>str1.append(&quot;E&quot;)</code>后<code>x 0x1000151E0</code> -&gt; <code>30 31 32 33 34 35 36 37 38 39 41 42 43 44 45 ef</code></li>
<li>显然，当添加后长度低于<code>0xF</code>后，其内存仍然存储在地址内存上</li>
</ul>
</li>
<li>当添加后大于<code>0xF</code>，<code>str1.append(&quot;G&quot;)</code> -&gt; <code>0xf000000000000010 0x000060000170c000</code>，此时<code>tag</code>和此前不同为<code>f</code>,其长度为<code>16</code>,查看其存储地址<code>0x000060000170c000</code>,显然其地址+<code>0x20</code>之后开始存储字符串的真实内容。实际上字符串拼接长度大于<code>oxF</code>后，会存储在堆中，其内存存储在地址后<code>0x20</code>（前<code>16</code>个字节，类似对象，<code>metaDat</code>和引用计数）后 <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs swift">x<span class="hljs-operator">/</span>50xb <span class="hljs-number">0x000060000170c000</span><br> <span class="hljs-number">0x60000170c000</span>: <span class="hljs-number">0xa8</span> <span class="hljs-number">0xe9</span> <span class="hljs-number">0x3f</span> <span class="hljs-number">0x4f</span> <span class="hljs-number">0xf8</span> <span class="hljs-number">0x7f</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span><br> <span class="hljs-number">0x60000170c008</span>: <span class="hljs-number">0x03</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span><br> <span class="hljs-number">0x60000170c010</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span><br> <span class="hljs-number">0x60000170c018</span>: <span class="hljs-number">0x10</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0xf0</span><br> <span class="hljs-number">0x60000170c020</span>: <span class="hljs-number">0x30</span> <span class="hljs-number">0x31</span> <span class="hljs-number">0x32</span> <span class="hljs-number">0x33</span> <span class="hljs-number">0x34</span> <span class="hljs-number">0x35</span> <span class="hljs-number">0x36</span> <span class="hljs-number">0x37</span><br> <span class="hljs-number">0x60000170c028</span>: <span class="hljs-number">0x38</span> <span class="hljs-number">0x39</span> <span class="hljs-number">0x41</span> <span class="hljs-number">0x42</span> <span class="hljs-number">0x43</span> <span class="hljs-number">0x44</span> <span class="hljs-number">0x45</span> <span class="hljs-number">0x47</span><br> <span class="hljs-number">0x60000170c030</span>: <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span><br></code></pre></td></tr></table></figure>
<ul>
<li>判断为何在堆中，断点查看<code>malloc</code>方法，查看<code>append</code>是否有分配堆空间，显然拦截成功，分配了堆空间<ul>
<li>查看<code>malloc</code>生成的堆空间地址<code>rax = 0x000060000170c000</code>,即最后字符串的后<code>8</code>字节地址<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs swift">  bt<br>  <span class="hljs-operator">*</span> thread #<span class="hljs-number">1</span>, queue <span class="hljs-operator">=</span> &#x27;com.apple.main<span class="hljs-operator">-</span>thread&#x27;, stop reason <span class="hljs-operator">=</span> breakpoint <span class="hljs-number">2.1</span><br><span class="hljs-operator">*</span> frame #<span class="hljs-number">0</span>: <span class="hljs-number">0x00007ff80b89ec19</span> libsystem_malloc.dylib`_malloc_zone_malloc <span class="hljs-operator">+</span> <span class="hljs-number">10</span><br>  frame #<span class="hljs-number">1</span>: <span class="hljs-number">0x00007ff81a1a2b96</span> libswiftCore.dylib`std::__1::pair<span class="hljs-operator">&lt;</span>(anonymous namespace)::<span class="hljs-type">TupleCacheEntry</span><span class="hljs-operator">*</span>, swift::<span class="hljs-type">MetadataResponse</span><span class="hljs-operator">&gt;</span> swift::<span class="hljs-type">LockingConcurrentMap</span>&lt;(anonymous namespace)::<span class="hljs-type">TupleCacheEntry</span>, (anonymous namespace)::<span class="hljs-type">TupleCacheStorage</span>&gt;::getOrInsert<span class="hljs-operator">&lt;</span>(anonymous namespace)::<span class="hljs-type">TupleCacheEntry</span>::<span class="hljs-type">Key</span>, swift::<span class="hljs-type">MetadataRequest</span><span class="hljs-operator">&amp;</span>, swift::<span class="hljs-type">TargetValueWitnessTable</span>&lt;swift::<span class="hljs-type">InProcess</span>&gt; const<span class="hljs-operator">*&amp;&gt;</span>((anonymous namespace)::TupleCacheEntry::<span class="hljs-type">Key</span>, swift::<span class="hljs-type">MetadataRequest</span><span class="hljs-operator">&amp;</span>, swift::<span class="hljs-type">TargetValueWitnessTable</span>&lt;swift::<span class="hljs-type">InProcess</span>&gt; const<span class="hljs-operator">*&amp;</span>) <span class="hljs-operator">+</span> <span class="hljs-number">4038</span><br>  frame #<span class="hljs-number">2</span>: <span class="hljs-number">0x00007ff81a1a19b4</span> libswiftCore.dylib`swift_getTupleTypeMetadata <span class="hljs-operator">+</span> <span class="hljs-number">116</span><br>  frame #<span class="hljs-number">3</span>: <span class="hljs-number">0x00007ff81a1c41ce</span> libswiftCore.dylib`swift::<span class="hljs-type">Demangle</span>::__runtime::<span class="hljs-type">TypeDecoder</span>&lt;(anonymous namespace)::<span class="hljs-type">DecodedMetadataBuilder</span>&gt;::decodeMangledType(swift::Demangle::__runtime::<span class="hljs-type">Node</span><span class="hljs-operator">*</span>, unsigned int, bool) <span class="hljs-operator">+</span> <span class="hljs-number">9342</span><br>  frame #<span class="hljs-number">4</span>: <span class="hljs-number">0x00007ff81a1c149d</span> libswiftCore.dylib`swift_getTypeByMangledNodeImpl(swift::<span class="hljs-type">MetadataRequest</span>, swift::Demangle::__runtime::<span class="hljs-type">Demangler</span><span class="hljs-operator">&amp;</span>, swift::Demangle::__runtime::<span class="hljs-type">Node</span><span class="hljs-operator">*</span>, void const<span class="hljs-operator">*</span> const<span class="hljs-operator">*</span>, std::__1::function<span class="hljs-operator">&lt;</span>swift::<span class="hljs-type">TargetMetadata</span>&lt;swift::<span class="hljs-type">InProcess</span>&gt; const<span class="hljs-operator">*</span> (unsigned int, unsigned int)<span class="hljs-operator">&gt;</span>, std::__1::function<span class="hljs-operator">&lt;</span>swift::<span class="hljs-type">TargetWitnessTable</span>&lt;swift::<span class="hljs-type">InProcess</span>&gt; const<span class="hljs-operator">*</span> (swift::<span class="hljs-type">TargetMetadata</span>&lt;swift::<span class="hljs-type">InProcess</span>&gt; const<span class="hljs-operator">*</span>, unsigned int)<span class="hljs-operator">&gt;</span>) <span class="hljs-operator">+</span> <span class="hljs-number">493</span><br>  frame #<span class="hljs-number">5</span>: <span class="hljs-number">0x00007ff81a1c126d</span> libswiftCore.dylib`swift_getTypeByMangledNode <span class="hljs-operator">+</span> <span class="hljs-number">477</span><br>  frame #<span class="hljs-number">6</span>: <span class="hljs-number">0x00007ff81a1c1980</span> libswiftCore.dylib`swift_getTypeByMangledNameImpl(swift::<span class="hljs-type">MetadataRequest</span>, __swift::__runtime::llvm::<span class="hljs-type">StringRef</span>, void const<span class="hljs-operator">*</span> const<span class="hljs-operator">*</span>, std::__1::function<span class="hljs-operator">&lt;</span>swift::<span class="hljs-type">TargetMetadata</span>&lt;swift::<span class="hljs-type">InProcess</span>&gt; const<span class="hljs-operator">*</span> (unsigned int, unsigned int)<span class="hljs-operator">&gt;</span>, std::__1::function<span class="hljs-operator">&lt;</span>swift::<span class="hljs-type">TargetWitnessTable</span>&lt;swift::<span class="hljs-type">InProcess</span>&gt; const<span class="hljs-operator">*</span> (swift::<span class="hljs-type">TargetMetadata</span>&lt;swift::<span class="hljs-type">InProcess</span>&gt; const<span class="hljs-operator">*</span>, unsigned int)<span class="hljs-operator">&gt;</span>) <span class="hljs-operator">+</span> <span class="hljs-number">992</span><br>  frame #<span class="hljs-number">7</span>: <span class="hljs-number">0x00007ff81a1bdc4d</span> libswiftCore.dylib`swift_getTypeByMangledName <span class="hljs-operator">+</span> <span class="hljs-number">477</span><br>  frame #<span class="hljs-number">8</span>: <span class="hljs-number">0x00007ff81a1bde7e</span> libswiftCore.dylib`swift_getTypeByMangledNameInContext <span class="hljs-operator">+</span> <span class="hljs-number">174</span><br>  frame #<span class="hljs-number">9</span>: <span class="hljs-number">0x00007ff81a133c47</span> libswiftCore.dylib`__swift_instantiateConcreteTypeFromMangledName <span class="hljs-operator">+</span> <span class="hljs-number">39</span><br>  frame #<span class="hljs-number">10</span>: <span class="hljs-number">0x00007ff81a01f961</span> libswiftCore.dylib`<span class="hljs-type">Swift</span>._StringGuts.prepareForAppendInPlace(totalCount: <span class="hljs-type">Swift</span>.<span class="hljs-type">Int</span>, otherUTF8Count: <span class="hljs-type">Swift</span>.<span class="hljs-type">Int</span>) -&gt; () <span class="hljs-operator">+</span> <span class="hljs-number">385</span><br>  frame #<span class="hljs-number">11</span>: <span class="hljs-number">0x00007ff81a01fc16</span> libswiftCore.dylib`<span class="hljs-type">Swift</span>._StringGuts.append(<span class="hljs-type">Swift</span>._StringGutsSlice) -&gt; () <span class="hljs-operator">+</span> <span class="hljs-number">390</span><br>  frame #<span class="hljs-number">12</span>: <span class="hljs-number">0x000000010000e041</span> <span class="hljs-type">SwiftDText</span>`main at main.swift:<span class="hljs-number">69</span>:<span class="hljs-number">6</span><br>  frame #<span class="hljs-number">13</span>: <span class="hljs-number">0x00007ff80b6fd310</span> dyld`start <span class="hljs-operator">+</span> <span class="hljs-number">2432</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><strong>注意</strong>，一开始大于<code>oxF</code>的字符串(此前存在<code>常量区</code>)拼接后一样的存储在<code>堆</code>中，因为<code>常量区</code>是无法更改的</li>
</ul>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="空字符串的存储"><a href="#空字符串的存储" class="headerlink" title="空字符串的存储"></a><span id="jump">空字符串的存储</span></h2><blockquote>
<p>先分析下，空字符串在内存中是如何保存的</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">var</span> empty <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">let</span> ptr <span class="hljs-operator">=</span> <span class="hljs-built_in">withUnsafePointer</span>(to: <span class="hljs-operator">&amp;</span>empty) &#123; <span class="hljs-variable">$0</span>&#125;<br><span class="hljs-built_in">print</span>(ptr) <span class="hljs-comment">// 0x00007ff7bfefead0</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>lldb</code>查看,其前<code>16</code>个字节存储的大小是<code>0x0000000000000000</code> + <code>0xe000000000000000</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs swift">lldb) x<span class="hljs-operator">/</span>4xg <span class="hljs-number">0x00007ff7bfefead0</span><br><span class="hljs-number">0x7ff7bfefead0</span>: <span class="hljs-number">0x0000000000000000</span> <span class="hljs-number">0xe000000000000000</span><br><span class="hljs-number">0x7ff7bfefeae0</span>: <span class="hljs-number">0x0000000000000004</span> <span class="hljs-number">0x0000000100015330</span><br></code></pre></td></tr></table></figure></li>
<li><p>这里并不能看出<code>string</code>的内存结构，下面根据源码进行具体分析</p>
</li>
</ul>
<h2 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="String-Swift"><a href="#String-Swift" class="headerlink" title="String.Swift"></a><code>String.Swift</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c++">@frozen<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">String</span> &#123;</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-comment">// @SPI(Foundation)</span><br>  var _guts: _StringGuts<br><br>  @inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>  <span class="hljs-function">internal <span class="hljs-title">init</span><span class="hljs-params">(_ _guts: _StringGuts)</span> </span>&#123;<br>    self._guts = _guts<br>    _invariantCheck()<br>  &#125;<br><br>  <span class="hljs-comment">// This is intentionally a static function and not an initializer, because</span><br>  <span class="hljs-comment">// an initializer would conflict with the Int-parsing initializer, when used</span><br>  <span class="hljs-comment">// as function name, e.g.</span><br>  <span class="hljs-comment">//   [1, 2, 3].map(String.init)</span><br>  @_alwaysEmitIntoClient<br>  @_semantics(<span class="hljs-string">&quot;string.init_empty_with_capacity&quot;</span>)<br>  @_semantics(<span class="hljs-string">&quot;inline_late&quot;</span>)<br>  @inlinable<br>  internal <span class="hljs-keyword">static</span> func _createEmpty(withInitialCapacity: Int) -&gt; String &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>(_StringGuts(_initialCapacity: withInitialCapacity))<br>  &#125;<br><br>  <span class="hljs-comment">/// Creates an empty string.</span><br>  <span class="hljs-comment">///</span><br>  <span class="hljs-comment">/// Using this initializer is equivalent to initializing a string with an</span><br>  <span class="hljs-comment">/// empty string literal.</span><br>  <span class="hljs-comment">///</span><br>  <span class="hljs-comment">///     let empty = &quot;&quot;</span><br>  <span class="hljs-comment">///     let alsoEmpty = String()</span><br>  @inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>  @_semantics(<span class="hljs-string">&quot;string.init_empty&quot;</span>)<br>  <span class="hljs-keyword">public</span> <span class="hljs-built_in">init</span>() &#123; self.<span class="hljs-built_in">init</span>(_StringGuts()) &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>最直观地可以看到<code>String</code>是一个结构体，就是我们所说的值类型；它有一个成员变量<code>_StringGuts</code>,其中最后有一个创建空字符串初始化方式<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">self</span>.<span class="hljs-keyword">init</span>(_StringGuts())<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="StringGuts"><a href="#StringGuts" class="headerlink" title="_StringGuts"></a><code>_StringGuts</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c++">/<br><span class="hljs-comment">// StringGuts is a parameterization over String&#x27;s representations. It provides</span><br><span class="hljs-comment">// functionality and guidance for efficiently working with Strings.</span><br><span class="hljs-comment">//</span><br>@frozen<br><span class="hljs-keyword">public</span> <span class="hljs-comment">// SPI(corelibs-foundation)</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">StringGuts</span>:</span> @unchecked Sendable &#123;<br>  @usableFromInline<br>  internal var _object: _StringObject<br><br>  @inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>  <span class="hljs-function">internal <span class="hljs-title">init</span><span class="hljs-params">(_ object: _StringObject)</span> </span>&#123;<br>    self._object = object<br>    _invariantCheck()<br>  &#125;<br><br>  <span class="hljs-comment">// Empty string</span><br>  @inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>  <span class="hljs-built_in">init</span>() &#123;<br>    self.<span class="hljs-built_in">init</span>(_StringObject(empty: ()))<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// Raw</span><br>extension _StringGuts &#123;<br>  @inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>  internal var rawBits: _StringObject.RawBitPattern &#123;<br>    <span class="hljs-keyword">return</span> _object.rawBits<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li><code>_StringGuts</code>也是一个结构体，它有一个成员变量是<code>_StringObject</code>类型的实例;并且在最后是通过初始化出一个<code>_StringObject</code>类型的实例来初始化<code>_StringGuts</code>的。因此真正<code>swift</code>的实质就是<code>_StringObject</code></li>
</ul>
<h3 id="StringObject"><a href="#StringObject" class="headerlink" title="_StringObject"></a><code>_StringObject</code></h3><ul>
<li><p>创建空字符串的方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++">@inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>  <span class="hljs-function">internal <span class="hljs-title">init</span><span class="hljs-params">(empty:())</span> </span>&#123;<br>    <span class="hljs-comment">// Canonical empty pattern: small zero-length string</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> arch(i386) || arch(arm) || arch(arm64_32) || arch(wasm32)</span><br>    self.<span class="hljs-built_in">init</span>(<br>      count: <span class="hljs-number">0</span>,<br>      variant: .<span class="hljs-built_in">immortal</span>(<span class="hljs-number">0</span>),<br>      discriminator: Nibbles.emptyString,<br>      flags: <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br>    self._countAndFlagsBits = <span class="hljs-number">0</span><br>    self._object = Builtin.<span class="hljs-built_in">valueToBridgeObject</span>(Nibbles.emptyString._value)<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    _internalInvariant(self.smallCount == <span class="hljs-number">0</span>)<br>    _invariantCheck()<br>  &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>初始化方法,其内有成员变量<code>_count</code>,<code>_variant</code>,<code>_discriminator</code>,<code>_flags</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++">@usableFromInline<br>  internal var _count: Int <span class="hljs-comment">// 字符串大小</span><br><br>  @usableFromInline<br>  internal var _variant: Variant <span class="hljs-comment">// 枚举值 默认0</span><br><br>  @usableFromInline<br>  internal var _discriminator: UInt8 <span class="hljs-comment">// 空字符串在初始化的时候传递了一个Nibbles.emptyString</span><br><br>  @usableFromInline<br>  internal var _flags: UInt16<br><br>  @inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>  <span class="hljs-built_in">init</span>(count: Int, variant: Variant, discriminator: UInt64, flags: UInt16) &#123;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> os(Android) &amp;&amp; arch(arm64)</span><br>    _internalInvariant(discriminator &amp; <span class="hljs-number">0x00FF</span>_0000_0000_0000 == discriminator,<br>      <span class="hljs-string">&quot;only the second byte can carry the discriminator and small count on Android AArch64&quot;</span>)<br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br>    _internalInvariant(discriminator &amp; <span class="hljs-number">0xFF00</span>_0000_0000_0000 == discriminator,<br>      <span class="hljs-string">&quot;only the top byte can carry the discriminator and small count&quot;</span>)<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br>    self._count = count<br>    self._variant = variant<br>    self._discriminator = <span class="hljs-built_in">UInt8</span>(truncatingIfNeeded: discriminator &amp;&gt;&gt; <span class="hljs-number">56</span>)<br>    self._flags = flags<br>    self._invariantCheck()<br>  &#125;<br></code></pre></td></tr></table></figure></li>
<li><p><code>Variant</code>是一个枚举值，默认是<code>immortal 0</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++">internal <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Variant</span> &#123;</span><br>    <span class="hljs-function"><span class="hljs-keyword">case</span> <span class="hljs-title">immortal</span><span class="hljs-params">(UInt)</span> <span class="hljs-comment">// 原始字符串</span></span><br><span class="hljs-function">    <span class="hljs-keyword">case</span> <span class="hljs-title">native</span><span class="hljs-params">(AnyObject)</span> <span class="hljs-comment">// AnyObject</span></span><br><span class="hljs-function">    <span class="hljs-keyword">case</span> <span class="hljs-title">bridged</span><span class="hljs-params">(_CocoaString)</span> <span class="hljs-comment">// NSString</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">    @inlinable @<span class="hljs-title">inline</span><span class="hljs-params">(__always)</span></span><br><span class="hljs-function">    internal <span class="hljs-keyword">static</span> func <span class="hljs-title">immortal</span><span class="hljs-params">(start: UnsafePointer&lt;UInt8&gt;)</span> -&gt; Variant </span>&#123;<br>      let biased = <span class="hljs-built_in">UInt</span>(bitPattern: start) &amp;- _StringObject.nativeBias<br>      <span class="hljs-keyword">return</span> .<span class="hljs-built_in">immortal</span>(biased)<br>    &#125;<br><br>    @inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>    internal var isImmortal: Bool &#123;<br>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .immortal = self &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure></li>
<li><p><code>internal var _discriminator: UInt8</code> 在初始化的时候传递了一个<code>Nibbles.emptyString</code>（<code>Nibbles</code>是一个枚举类型）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> Encoding is optimized for common fast creation. The canonical empty string,</span><br><span class="hljs-comment"> ASCII small strings, as well as most literals, have all consecutive 1s in their</span><br><span class="hljs-comment"> high nibble mask, and thus can all be encoded as a logical immediate operand</span><br><span class="hljs-comment"> on arm64.</span><br><span class="hljs-comment">*/</span><br>extension _StringObject.Nibbles &#123;<br>  <span class="hljs-comment">// The canonical empty string is an empty small string</span><br>  @inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>  internal <span class="hljs-keyword">static</span> var emptyString: UInt64 &#123;<br>    <span class="hljs-keyword">return</span> _StringObject.Nibbles.<span class="hljs-built_in">small</span>(isASCII: <span class="hljs-literal">true</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// Discriminator for small strings</span><br>  @inlinable @<span class="hljs-built_in"><span class="hljs-keyword">inline</span></span>(__always)<br>  internal <span class="hljs-keyword">static</span> func <span class="hljs-built_in">small</span>(isASCII: Bool) -&gt; UInt64 &#123;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> os(Android) &amp;&amp; arch(arm64)</span><br>    <span class="hljs-keyword">return</span> isASCII ? <span class="hljs-number">0x00E0</span>_0000_0000_0000 : <span class="hljs-number">0x00A0</span>_0000_0000_0000<br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br>    <span class="hljs-keyword">return</span> isASCII ? <span class="hljs-number">0xE000</span>_0000_0000_0000 : <span class="hljs-number">0xA000</span>_0000_0000_0000<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>  &#125;<br></code></pre></td></tr></table></figure></li>
<li><p><code>0x00E0_0000_0000_0000</code>和<a href="#jump">空字符串的存储</a>中空字符串的内存一致</p>
</li>
</ul>
<h2 id="小于长度0xF的字符串-1"><a href="#小于长度0xF的字符串-1" class="headerlink" title="小于长度0xF的字符串"></a>小于长度<code>0xF</code>的字符串</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">var</span> str1 <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0123456789&quot;</span><br><span class="hljs-comment">//内存：0x3736353433323130  0xea00000000003938</span><br><span class="hljs-keyword">var</span> str2 <span class="hljs-operator">=</span> <span class="hljs-string">&quot;中&quot;</span><br><span class="hljs-comment">//内存：0x0000000000adb8e4 0xa300000000000000</span><br></code></pre></td></tr></table></figure>
<ul>
<li><code>small strings</code>的<code>Discriminator</code>,<ul>
<li>中文字符不是<code>ASCII</code>编码，一个中文字符占据<code>3</code>个字节（<code>24</code>位),其<code>Discriminator</code>为<code>0xa000000000000000</code>,这里的长度<code>3</code>并非真实长度，而是其字节数。</li>
<li><code>&quot;0123456789&quot;</code>,是<code>ASCII</code>编码,并且一个字符占<code>1</code>哥字节，其<code>Discriminator</code>为<code>0xe000000000000000</code><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs swift"> <span class="hljs-comment">// Discriminator for small strings</span><br>  <span class="hljs-keyword">@inlinable</span> <span class="hljs-meta">@inline</span>(__always)<br>  <span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">small</span>(<span class="hljs-params">isASCII</span>: <span class="hljs-type">Bool</span>)</span> -&gt; <span class="hljs-type">UInt64</span> &#123;<br><span class="hljs-keyword">#if</span> os(<span class="hljs-type">Android</span>) <span class="hljs-operator">&amp;&amp;</span> arch(arm64)<br>    <span class="hljs-keyword">return</span> isASCII <span class="hljs-operator">?</span> <span class="hljs-number">0x00E0_0000_0000_0000</span> : <span class="hljs-number">0x00A0_0000_0000_0000</span><br><span class="hljs-keyword">#else</span><br>    <span class="hljs-keyword">return</span> isASCII <span class="hljs-operator">?</span> <span class="hljs-number">0xE000_0000_0000_0000</span> : <span class="hljs-number">0xA000_0000_0000_0000</span><br><span class="hljs-keyword">#endif</span><br>  &#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="大于长度0xF的字符串-1"><a href="#大于长度0xF的字符串-1" class="headerlink" title="大于长度0xF的字符串"></a>大于长度<code>0xF</code>的字符串</h2><blockquote>
<p>对于大字符串(大于<code>15</code>个字符串)来说，原本的小字符串占据的<code>15</code>个字节已经不足以存储字符串了，那就会发生改变</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">var</span> str1 <span class="hljs-operator">=</span> `<span class="hljs-string">&quot;0123456789ABCDEFGH&quot;</span><br><span class="hljs-comment">//内存地址:0xd000000000000012.  0x8000000100003f70</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>largeImmortal</code>的<code>Discriminator</code></p>
<ul>
<li>这里<code> 0x0080_0000_0000_0000</code>，是<code>Discriminator</code>，剩下的<code>0x100003f70</code>实际上关联了实际存储的字符串<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">// Discriminator for large, immortal, swift-native strings</span><br>  <span class="hljs-keyword">@inlinable</span> <span class="hljs-meta">@inline</span>(__always)<br>  <span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">largeImmortal</span>()</span> -&gt; <span class="hljs-type">UInt64</span> &#123;<br><span class="hljs-keyword">#if</span> os(<span class="hljs-type">Android</span>) <span class="hljs-operator">&amp;&amp;</span> arch(arm64)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0x0080_0000_0000_0000</span><br><span class="hljs-keyword">#else</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0x8000_0000_0000_0000</span><br><span class="hljs-keyword">#endif</span><br>  &#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>源码意思是实际的字符串需要加上偏移量<code>nativeBias</code>即<code>32</code>，<code>32</code>的<code>16</code>进制是<code>0x20</code>实际字符串存储的位置是<code>0x100003f70 + 20</code> = <code>0x100003f90</code>,</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-type">Large</span> strings can either be <span class="hljs-string">&quot;native&quot;</span>, <span class="hljs-string">&quot;shared&quot;</span>, or <span class="hljs-string">&quot;foreign&quot;</span>.<br><br> <span class="hljs-type">Native</span> strings have tail<span class="hljs-operator">-</span>allocated storage, which begins at an offset of<br> `nativeBias` from the storage object&#x27;s address. <span class="hljs-type">String</span> literals, which reside<br> <span class="hljs-keyword">in</span> the constant section, are encoded <span class="hljs-keyword">as</span> their start address minus `nativeBias`,<br> unifying code paths <span class="hljs-keyword">for</span> both literals (<span class="hljs-string">&quot;immortal native&quot;</span>) and native strings.<br> <span class="hljs-type">Native</span> <span class="hljs-type">Strings</span> are always managed by the <span class="hljs-type">Swift</span> runtime.<br><br> <span class="hljs-type">Shared</span> strings <span class="hljs-keyword">do</span> not have tail<span class="hljs-operator">-</span>allocated storage, but can provide access<br> upon query to contiguous <span class="hljs-type">UTF</span><span class="hljs-operator">-</span><span class="hljs-number">8</span> code units. <span class="hljs-type">Lazily</span><span class="hljs-operator">-</span>bridged <span class="hljs-type">NSStrings</span> capable of<br> providing access to contiguous <span class="hljs-type">ASCII</span><span class="hljs-operator">/</span><span class="hljs-type">UTF</span><span class="hljs-operator">-</span><span class="hljs-number">8</span> <span class="hljs-keyword">set</span> the <span class="hljs-type">ObjC</span> bit. <span class="hljs-type">Accessing</span> shared<br> string&#x27;s pointer should always be behind a resilience barrier, permitting<br> future evolution.<br><br> <span class="hljs-type">Foreign</span> strings cannot provide access to contiguous <span class="hljs-type">UTF</span><span class="hljs-operator">-</span><span class="hljs-number">8</span>. <span class="hljs-type">Currently</span>, this only<br> encompasses lazily<span class="hljs-operator">-</span>bridged <span class="hljs-type">NSStrings</span> that cannot be treated <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;shared&quot;</span>. <span class="hljs-type">Such</span><br> strings may provide access to contiguous <span class="hljs-type">UTF</span><span class="hljs-operator">-</span><span class="hljs-number">16</span>, or may be discontiguous <span class="hljs-keyword">in</span><br> storage. <span class="hljs-type">Accessing</span> foreign strings should remain behind a resilience barrier<br> <span class="hljs-keyword">for</span> future evolution. <span class="hljs-type">Other</span> foreign forms are reserved <span class="hljs-keyword">for</span> the future.<br><br> <span class="hljs-type">Shared</span> and foreign strings are always created and accessed behind a resilience<br> barrier, providing flexibility <span class="hljs-keyword">for</span> the future.<br><br> <span class="hljs-operator">┌────────────┐</span><br> <span class="hljs-operator">│</span> nativeBias <span class="hljs-operator">│</span><br> <span class="hljs-operator">├────────────┤</span><br> <span class="hljs-operator">│</span>     <span class="hljs-number">32</span>     <span class="hljs-operator">│</span><br> <span class="hljs-operator">└────────────┘</span><br><br> <span class="hljs-operator">┌───────────────┬────────────┐</span><br> <span class="hljs-operator">│</span>    b63:b60    <span class="hljs-operator">│</span>   b60:b0   <span class="hljs-operator">│</span><br> <span class="hljs-operator">├───────────────┼────────────┤</span><br> <span class="hljs-operator">│</span> discriminator <span class="hljs-operator">│</span> objectAddr <span class="hljs-operator">│</span><br> <span class="hljs-operator">└───────────────┴────────────┘</span><br><br> discriminator: <span class="hljs-type">See</span> comment <span class="hljs-keyword">for</span> _StringObject.<span class="hljs-type">Discriminator</span><br> objectAddr: <span class="hljs-type">The</span> address of the beginning of the potentially<span class="hljs-operator">-</span>managed object.<br><br> <span class="hljs-type">TODO</span>(<span class="hljs-type">Future</span>): <span class="hljs-type">For</span> <span class="hljs-type">Foreign</span> strings, consider allocating a bit <span class="hljs-keyword">for</span> whether they<br> can provide contiguous <span class="hljs-type">UTF</span><span class="hljs-operator">-</span><span class="hljs-number">16</span> code units, which would allow us to avoid doing<br> the full call <span class="hljs-keyword">for</span> non<span class="hljs-operator">-</span>contiguous <span class="hljs-type">NSString</span>.<br><br></code></pre></td></tr></table></figure></li>
<li><p>而大字符串前面的标识位<code>0xd000000000000012</code></p>
<ul>
<li><code>0-47</code>位是长度，这里是<code>0x12</code>即长度为18<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-type">All</span> non<span class="hljs-operator">-</span>small forms share the same structure <span class="hljs-keyword">for</span> the other half of the bits<br> (i.e. non<span class="hljs-operator">-</span>object bits) <span class="hljs-keyword">as</span> a word containing code unit count and various<br> performance flags. <span class="hljs-type">The</span> top <span class="hljs-number">16</span> bits are nonessential flags; these aren&#x27;t<br> critical <span class="hljs-keyword">for</span> correct operation, but they may provide additional guarantees that<br> allow more efficient operation or more reliable detection of runtime errors.<br> <span class="hljs-type">The</span> lower <span class="hljs-number">48</span> bits contain the code unit count (aka endIndex).<br><br><span class="hljs-operator">┌──────┬──────┬──────┬──────┬──────┬──────────┬───────────────────────────────┐</span><br><span class="hljs-operator">│</span> b63  <span class="hljs-operator">│</span> b62  <span class="hljs-operator">│</span> b61  <span class="hljs-operator">│</span> b60  <span class="hljs-operator">│</span> b59  <span class="hljs-operator">│</span>  b58:<span class="hljs-number">48</span>  <span class="hljs-operator">│</span>             b47:<span class="hljs-number">0</span>             <span class="hljs-operator">│</span><br><span class="hljs-operator">├──────┼──────┼──────┼──────┼──────┼──────────┼───────────────────────────────┤</span><br><span class="hljs-operator">│</span> <span class="hljs-type">ASCII</span><span class="hljs-operator">│</span> <span class="hljs-type">NFC</span>  <span class="hljs-operator">│</span>native<span class="hljs-operator">│</span> tail <span class="hljs-operator">│</span> <span class="hljs-type">UTF8</span> <span class="hljs-operator">│</span> reserved <span class="hljs-operator">│</span>             count             <span class="hljs-operator">│</span><br><span class="hljs-operator">└──────┴──────┴──────┴──────┴──────┴──────────┴───────────────────────────────┘</span><br><br> b63: isASCII. <span class="hljs-keyword">set</span> when all code units are known to be <span class="hljs-type">ASCII</span>, enabling:<br>   <span class="hljs-operator">-</span> <span class="hljs-type">Trivial</span> <span class="hljs-type">Unicode</span> scalars, they&#x27;re just the code units<br>   <span class="hljs-operator">-</span> <span class="hljs-type">Trivial</span> <span class="hljs-type">UTF</span><span class="hljs-operator">-</span><span class="hljs-number">16</span> transcoding (just bit<span class="hljs-operator">-</span>extend)<br>   <span class="hljs-operator">-</span> <span class="hljs-type">Also</span>, isASCII always implies isNFC<br><br> b62: isNFC. <span class="hljs-keyword">set</span> when the contents are <span class="hljs-keyword">in</span> normal form <span class="hljs-type">C</span><br>   <span class="hljs-operator">-</span> <span class="hljs-type">Enables</span> trivial lexicographical comparisons: just memcmp<br>   <span class="hljs-operator">-</span> `isASCII` always implies `isNFC`, but not vice versa<br><br> b61: isNativelyStored. <span class="hljs-keyword">set</span> <span class="hljs-keyword">for</span> native stored strings<br>   <span class="hljs-operator">-</span> `largeAddressBits` holds an instance of `_StringStorage`.<br>   <span class="hljs-operator">-</span> <span class="hljs-type">I</span>.e. the start of the code units <span class="hljs-keyword">is</span> at the stored address <span class="hljs-operator">+</span> `nativeBias`<br>   <span class="hljs-operator">-</span> <span class="hljs-type">NOTE</span>: isNativelyStored <span class="hljs-keyword">is</span> <span class="hljs-operator">*</span>specifically<span class="hljs-operator">*</span> allocated to b61 to align with the<br>     bit<span class="hljs-operator">-</span>position of isSmall on the <span class="hljs-type">BridgeObject</span>. <span class="hljs-type">This</span> allows us to check <span class="hljs-keyword">for</span><br>     native storage without an extra branch guarding against smallness. <span class="hljs-type">See</span><br>     `_StringObject.hasNativeStorage` <span class="hljs-keyword">for</span> this usage.<br><br> b60: isTailAllocated. contiguous <span class="hljs-type">UTF</span><span class="hljs-operator">-</span><span class="hljs-number">8</span> code units starts at address <span class="hljs-operator">+</span> `nativeBias`<br>   <span class="hljs-operator">-</span> `isNativelyStored` always implies `isTailAllocated`, but not vice versa<br>      (e.g. literals)<br>   <span class="hljs-operator">-</span> `isTailAllocated` always implies `isFastUTF8`<br><br> b59: isForeignUTF8. <span class="hljs-type">This</span> bit <span class="hljs-keyword">is</span> to be <span class="hljs-keyword">set</span> on future <span class="hljs-type">UTF</span><span class="hljs-operator">-</span><span class="hljs-number">8</span> encoded string<br>      variants, i.e. on strings whose index positions are measured <span class="hljs-keyword">in</span> <span class="hljs-type">UTF</span><span class="hljs-operator">-</span><span class="hljs-number">8</span> code<br>      units, even though their storage isn&#x27;t continuous. <span class="hljs-type">As</span> of <span class="hljs-type">Swift</span> <span class="hljs-number">5.7</span>, we<br>      don&#x27;t have any such foreign forms, but inlinable index validation methods<br>      need to prepare <span class="hljs-keyword">for</span> the possibility of their introduction, so we need to<br>      assign this bit <span class="hljs-keyword">in</span> preparation.<br><br>      <span class="hljs-type">If</span> we decide to never introduce such forms, we can stop checking this bit<br>      at any time, but we cannot reuse it <span class="hljs-keyword">for</span> something <span class="hljs-keyword">else</span> <span class="hljs-operator">--</span> we need to<br>      preserve its current meaning to keep inlined index validation code<br>      working.<br><br> b48<span class="hljs-operator">-</span><span class="hljs-number">58</span>: <span class="hljs-type">Reserved</span> <span class="hljs-keyword">for</span> future usage.<br>   <span class="hljs-operator">-</span> <span class="hljs-type">Because</span> <span class="hljs-type">Swift</span> <span class="hljs-keyword">is</span> <span class="hljs-type">ABI</span> stable (on <span class="hljs-keyword">some</span> platforms at least), these bits can<br>     only be assigned semantics that don&#x27;t affect interoperability with code<br>     built with previous releases of the <span class="hljs-type">Standard</span> <span class="hljs-type">Library</span>, from <span class="hljs-number">5.0</span> onward.<br>   <span class="hljs-operator">-</span> <span class="hljs-type">Older</span> binaries will not look at newly assigned bits, and they will not<br>     <span class="hljs-keyword">set</span> them, either (unless by side effect of calling into newly built code).<br>     <span class="hljs-type">Such</span> code must <span class="hljs-keyword">continue</span> working.<br>   <span class="hljs-operator">-</span> <span class="hljs-type">Code</span> <span class="hljs-keyword">in</span> new versions of the stdlib must <span class="hljs-keyword">continue</span> to work correctly even <span class="hljs-keyword">if</span><br>     <span class="hljs-keyword">some</span> of these newly assigned bits are never <span class="hljs-keyword">set</span> <span class="hljs-operator">--</span> <span class="hljs-keyword">as</span> may be the <span class="hljs-keyword">case</span> when<br>     the initialization of a string was emitted entirely into an older client<br>     binary.<br>   <span class="hljs-operator">-</span> <span class="hljs-type">This</span> typically means that these bits can only be used <span class="hljs-keyword">as</span> <span class="hljs-keyword">optional</span><br>     performance shortcuts, e.g. to signal the availability of a potential fast<br>     path. (<span class="hljs-type">However</span>, it <span class="hljs-keyword">is</span> also possible to store information here that allows<br>     more reliable detection <span class="hljs-operator">&amp;</span> handling of runtime errors, like the<br>     `isForeignUTF8` bit above.)<br><br> b0<span class="hljs-operator">-</span><span class="hljs-number">47</span>: count. <span class="hljs-type">Stores</span> the number of code units. <span class="hljs-type">Corresponds</span> to the position of<br>     the `endIndex`.<br><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">jingbo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/03/12/iOS%E5%AD%A6%E4%B9%A0/Swift%E7%AC%94%E8%AE%B0/%E5%AD%97%E7%AC%A6%E4%B8%B2/">http://example.com/2023/03/12/iOS%E5%AD%A6%E4%B9%A0/Swift%E7%AC%94%E8%AE%B0/%E5%AD%97%E7%AC%A6%E4%B8%B2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/banner/banner_54.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/13/iOS%E5%AD%A6%E4%B9%A0/Swift%E7%AC%94%E8%AE%B0/Array/" title="Array"><img class="cover" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/banner/banner_57.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Array</div></div></a></div><div class="next-post pull-right"><a href="/2023/03/06/iOS%E5%AD%A6%E4%B9%A0/Swift%E7%AC%94%E8%AE%B0/%E5%88%9D%E5%A7%8B%E5%8C%96/" title="类的初始化"><img class="cover" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/banner/banner_47.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">类的初始化</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">jingbo</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">97</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">17</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xxxxx" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">欢迎来的bo的博客<div class="twopeople"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%98%E9%87%8F%E5%8D%A0%E7%94%A8%E5%A4%9A%E5%B0%91%E5%86%85%E5%AD%98"><span class="toc-number">1.</span> <span class="toc-text">一个字符串变量占用多少内存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%BA%95%E5%B1%82%E5%AD%98%E5%82%A8"><span class="toc-number">2.</span> <span class="toc-text">字符串的底层存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E4%BA%8E%E9%95%BF%E5%BA%A60xF%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">2.1.</span> <span class="toc-text">小于长度0xF的字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E4%BA%8E%E9%95%BF%E5%BA%A60xF%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">2.2.</span> <span class="toc-text">大于长度0xF的字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E5%90%8E%E7%9A%84%E5%86%85%E5%AD%98%E6%94%BE%E5%9C%A8%E9%82%A3%E9%87%8C"><span class="toc-number">2.3.</span> <span class="toc-text">字符串拼接后的内存放在那里</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A9%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%AD%98%E5%82%A8"><span class="toc-number">3.1.</span> <span class="toc-text">空字符串的存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="toc-number">3.2.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#String-Swift"><span class="toc-number">3.2.1.</span> <span class="toc-text">String.Swift</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StringGuts"><span class="toc-number">3.2.2.</span> <span class="toc-text">_StringGuts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StringObject"><span class="toc-number">3.2.3.</span> <span class="toc-text">_StringObject</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E4%BA%8E%E9%95%BF%E5%BA%A60xF%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2-1"><span class="toc-number">3.3.</span> <span class="toc-text">小于长度0xF的字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E4%BA%8E%E9%95%BF%E5%BA%A60xF%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2-1"><span class="toc-number">3.4.</span> <span class="toc-text">大于长度0xF的字符串</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/07/02/iOS%E5%AD%A6%E4%B9%A0/Swift%E8%BF%9B%E9%98%B6/%E6%B3%9B%E5%9E%8B%E5%8E%9F%E7%90%86/" title="泛型原理"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/banner/banner_41.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="泛型原理"/></a><div class="content"><a class="title" href="/2023/07/02/iOS%E5%AD%A6%E4%B9%A0/Swift%E8%BF%9B%E9%98%B6/%E6%B3%9B%E5%9E%8B%E5%8E%9F%E7%90%86/" title="泛型原理">泛型原理</a><time datetime="2023-07-02T13:46:46.000Z" title="Created 2023-07-02 21:46:46">2023-07-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/26/iOS%E5%AD%A6%E4%B9%A0/Swift%E8%BF%9B%E9%98%B6/%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/" title="协议分析"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/banner/banner_38.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="协议分析"/></a><div class="content"><a class="title" href="/2023/06/26/iOS%E5%AD%A6%E4%B9%A0/Swift%E8%BF%9B%E9%98%B6/%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/" title="协议分析">协议分析</a><time datetime="2023-06-26T15:49:41.000Z" title="Created 2023-06-26 23:49:41">2023-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/24/iOS%E5%AD%A6%E4%B9%A0/Swift%E8%BF%9B%E9%98%B6/%E9%97%AD%E5%8C%85%E5%88%86%E6%9E%90/" title="闭包分析"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/banner/banner_49.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="闭包分析"/></a><div class="content"><a class="title" href="/2023/06/24/iOS%E5%AD%A6%E4%B9%A0/Swift%E8%BF%9B%E9%98%B6/%E9%97%AD%E5%8C%85%E5%88%86%E6%9E%90/" title="闭包分析">闭包分析</a><time datetime="2023-06-24T15:50:31.000Z" title="Created 2023-06-24 23:50:31">2023-06-24</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By jingbo</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script async src="/js/title.js"></script><script async src="/scripts/modify.js"></script><script defer src="https://cdn.jsdelivr.net/combine/npm/jquery@latest/dist/jquery.min.js,gh/weilining/jsdelivr/jquery/circlemagic/circlemagic.min.js,gh/weilining/jsdelivr@latest/jquery/circlemagic/butterflycirclemagic.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 3,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2dw"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>